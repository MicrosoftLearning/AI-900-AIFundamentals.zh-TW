---
lab:
  title: 探索物件偵測
---

# 探索物件偵測

> **注意** 若要完成此實驗室，您需要一個具備[系統管理存取權](https://azure.microsoft.com/free?azure-portal=true)的 Azure 訂用帳戶。

*物件偵測*是一種電腦視覺形式，其中機器學習模型會進行訓練，以分類影像中物件的個別執行個體，並指出標示其位置的「周框方塊」。 您可以將此視為「影像分類」的進展 (其中模型會回答「影像是什麼？」的問題)，以建置可詢問模型「此影像中有什麼物件？這些物件在哪？」的解決方案。

例如，道路安全計畫可能會將道路安全計畫識別為交通交集最易受攻擊的道路使用者。 藉由使用相機來監視交集，可以分析道路使用者的影像來偵測街道和自行車者，以監視其號碼，甚至變更交通訊號的行為。

Microsoft Azure 中的**自訂視覺**認知服務提供雲端式解決方案，用於建立及發佈自訂物件偵測模型。 在 Azure 中，您可以使用 自訂視覺 服務，根據現有的影像來定型物件偵測模型。 建立物件偵測解決方案有兩個元素。 首先，您必須定型模型，才能使用標示的影像來偵測物件的位置和類別。 然後，模型經訓練後，您必須將其發佈為服務以供應用程式取用。

為了測試自訂視覺服務用來偵測影像中物件的功能，我們會使用在 Cloud Shell 中執行的簡單命令列應用程式。 相同的原則和功能適用于真實世界的解決方案，例如網站或行動裝置應用程式。

## 建立「認知服務」資源

您可以建立**自訂視覺**資源或**認知服務**資源，以使用自訂視覺服務。

> **注意** 並非所有區域都有提供這些資源。 無論您建立的是自訂視覺資源或認知服務資源，只有在[特定區域](https://azure.microsoft.com/global-infrastructure/services/?products=cognitive-services)中建立的資源才能用於存取自訂視覺服務。 為了簡單起見，以下設定指示會預先為您選取某個區域。

在 Azure 訂閱中建立**認知服務**資源。

1. 在另一個瀏覽器索引標籤中，開啟位於 [https://portal.azure.com](https://portal.azure.com?azure-portal=true) 的 Azure 入口網站，並使用您的 Microsoft 帳戶登入。

1. 按一下 [&#65291;建立資源] 按鈕，搜尋「認知服務」，然後使用下列設定建立**認知服務**資源：
    - **訂用帳戶**：*您的 Azure 訂用帳戶*。
    - **資源群組**：*選取或建立具有唯一名稱的資源群組*。
    - **區域**：美國東部
    - **名稱**：輸入唯一名稱。
    - **定價層**:標準 S0
    - **核取此方塊表示我已閱讀並了解下列所有條款**：選取。

1. 檢閱並建立資源，然後等候部署完成。 接著，移至所部署的資源。

1. 檢視認知服務資源的 [金鑰與端點] 頁面。 您需要有端點和金鑰，才能從用戶端應用程式連線。

## 建立自訂視覺專案

若要訓練物件偵測模型，您必須根據訓練資源來建立自訂視覺專案。 為此，您將使用自訂視覺入口網站。

1. 在新的瀏覽器索引標籤中，開啟位於 [https://customvision.ai](https://customvision.ai?azure-portal=true) 的自訂視覺入口網站，並使用與您的 Azure 訂用帳戶相關聯的 Microsoft 帳戶登入。

1. 建立包含下列設定的新專案：
    - **名稱**：交通安全
    - **描述**：道路安全的物件偵測。
    - **資源**：您先前建立的資源
    - **專案類型**：物件偵測
    - **網域**：一般 \[ A1]

1. 等候專案建立並在瀏覽器中開啟。

## 新增並標記影像

若要訓練物件偵測模型，您必須上傳影像 (其包含想要模型識別的類別)，並加以標記來表示每個物件執行個體的周框方塊。

1. 從 [https://aka.ms/traffic-images](https://aka.ms/traffic-images) 下載並擷取定型影像。 所擷取的資料夾包含一組自行車和自行車影像。

1. 在自訂視覺入口網站中，于您的**流量安全**物件偵測專案中，選取 [**新增影像**] 並上傳所擷取資料夾中的所有影像。

    ![自訂視覺 Studio 中 [影像上傳] 對話方塊的螢幕擷取畫面。](media/create-object-detection-solution/upload-images.png)

1. 影像上傳完成後，選取第一個加以開啟。

1. 將滑鼠停留在影像中任何物件上 (自行車或) ，直到自動偵測到的區域顯示為止。 然後選取物件，如有必要調整區域大小以便將其環繞。 或者，您可以簡單地在物件周圍拖曳以建立區域。

    在矩形區域內緊密選取物件時，輸入物件 (*Cyclist* 或 *) * 的適當標籤，並使用 [ **標籤區域** **+** ] () 按鈕將標籤新增至專案。

    ![[影像 Detaol] 對話方塊中已標記區域的影像螢幕擷取畫面。](media/create-object-detection-solution/tag-image.png)

1. 使用右側的 **[下一個** ** ( (>) ** 連結來移至下一個影像，並標記其物件。 然後，只要持續處理整個影像集合，並標記每個自行車和自行車。

    當您標記影像時，請注意下列事項：

    - 有些影像包含多個物件，可能是不同類型的物件。 標記每一個，即使它們重迭也一樣。
    - 輸入標記一次之後，您可以在標記新物件時從清單中選取它。
    - 您可以透過影像來回轉，以調整標籤。

    ![[影像 Detaol] 對話方塊中已標記區域的影像螢幕擷取畫面。](media/create-object-detection-solution/multiple-objects.png)

1. 完成對最後一個影像的標記後，請關閉 [影像詳細資料] 編輯器，然後在 [訓練影像] 頁面上的 [標記] 下，選取 [已標記] 以查看所有已標記的影像：

    ![專案中已標記影像的螢幕擷取畫面。](media/create-object-detection-solution/tagged-images.png)

## 訓練並測試模型

現在您已經在專案中標記影像，可開始訓練模型。

1. 在自訂視覺專案中，按一下 [訓練] 以使用已標記的影像來訓練物件偵測模型。 選取 [Quick Training] (快速訓練) 選項。

    > **提示**：訓練可能需要幾分鐘的時間。 當您等候時，請查看 [智慧城市影片分析](https://www.microsoft.com/research/video/video-analytics-for-smart-cities/)，其中說明在道路安全改進計畫中使用電腦視覺的實際專案。

2. 定型完成時，請檢閱 *精確度*、 *召回*率和 *mAP* 效能計量 - 這些計量會測量物件偵測模型的預測良好性，而且應該全部都相當高。

3. 調整左邊的 **機率臨界值** ，將它從 50% 增加到 90%，並觀察效能計量的影響。 此設定會決定每個標記評估必須符合或超過的機率值，才能計算為預測。

    ![定型模型的效能計量螢幕擷取畫面。](media/create-object-detection-solution/performance-metrics.png)

4. 按一下頁面右上方的 [ **快速測試**]，然後在 [ **影像 URL** ] 方塊中輸入 `https://aka.ms/pedestrian-cyclist` 並檢視結果。

    在右側窗格的 **[預測**] 底下，會列出每個偵測到的物件及其標記和機率。 選取每個物件，以查看影像中反白顯示的物件。

    預測的物件可能全部都不正確-在所有之後，自行車者與精靈都會共用許多常見的特徵。 模型最有信心的預測具有最高的機率值。 使用 [ **臨界值]** 滑杆來消除機率較低的物件。 您應該能夠找到只包含正確預測的點， (大約 85-90% ) 。

    ![定型模型的效能計量螢幕擷取畫面。](media/create-object-detection-solution/test-detection.png)

5. 然後關閉 [Quick Test] (快速測試) 視窗。

## 發佈物件偵測模型

現在，您已準備好發佈已訓練的模型，並從用戶端應用程式加以使用。

1. 按一下 [&#128504; 發佈]，使用下列設定發佈已定型的模型：
    - **模型名稱**：流量安全
    - **預測資源**：您先前建立的資源。

1. 發佈之後，按一下 [預測 URL](&#127760;) 圖示，以查看使用已發佈的模型所需的資訊。

    ![預測 URL 的螢幕擷取畫面。](media/create-object-detection-solution/prediction-url.png)

之後，您需要適當的 URL 與 Prediction-Key 值，才能從影像 URL 取得預測，因此請讓此對話方塊保持開啟，並繼續進行下一個工作。

## 準備用戶端應用程式

為了測試自訂視覺服務的功能，我們將使用在 Azure 上 Cloud Shell 中執行的簡單命令列應用程式。

1. 切換回包含Azure 入口網站的瀏覽器索引標籤，然後選取搜尋方塊右邊頁面頂端的 (**[****>_]**) 按鈕。 這會開啟入口網站底部的 Cloud Shell 窗格。

    第一次開啟 Cloud Shell 時，系統可能會提示您選擇要使用的殼層類型 (*Bash* 或 *PowerShell*)。 如果是，請選取 **[PowerShell**]。

    如果系統提示您為Cloud Shell建立儲存體，請確定已選取您的訂用帳戶，然後選取 [**建立儲存體**]。 然後，請等候一分鐘左右，讓系統建立儲存體。

    當 Cloud Shell 就緒時，它看起來應該會像這樣：
    
    ![Azure 入口網站中的 Cloud Shell 螢幕擷取畫面。](media/create-object-detection-solution/cloud-shell.png)

    > **提示**：確定Cloud Shell窗格左上方所指出的殼層類型為*PowerShell*。 如果其類型為 *Bash*，請使用下拉式功能表切換為 *PowerShell*。

    請注意，如需調整 Cloud Shell 的大小，您可以拖曳窗格頂端的分隔線，或者使用窗格右上方的 **&#8212;** 、 **&#9723;** 、**X** 圖示，分別將窗格最小化、最大化或關閉窗格。 如需使用 Azure Cloud Shell 的詳細資訊，請參閱 [Azure Cloud Shell 文件](https://docs.microsoft.com/azure/cloud-shell/overview)。

2. 在命令殼層中，輸入下列命令來下載此練習的檔案，並在移除該資料夾之後，將其儲存在名為 **ai-900** (的資料夾中，如果資料夾已經存在) 

    ```PowerShell
    rm -r ai-900 -f
    git clone https://github.com/MicrosoftLearning/AI-900-AIFundamentals ai-900
    ```

3. 下載檔案之後，請輸入下列命令以變更為 **ai-900** 目錄，並編輯此練習的程式碼檔案：

    ```PowerShell
    cd ai-900
    code detect-objects.ps1
    ```

    請注意，這會如何開啟編輯器，如下圖中的編輯器：

     ![Cloud Shell 中程式碼編輯器的螢幕擷取畫面。](media/create-object-detection-solution/code-editor.png)

     > **提示**：您可以使用 Cloud Shell 命令列與程式碼編輯器之間的分隔線來調整窗格的大小。

4. 不用太過顧慮程式碼的細節。 請務必從一些程式碼開始，以指定自訂視覺模型的預測 URL 和金鑰。 您必須更新這些專案，讓程式碼的其餘部分使用您的模型。

    從您在自訂視覺專案的瀏覽器索引標籤中開啟的對話方塊中，取得*預測 URL*和*預測金鑰*。 *如果您有映射 URL*，則需要使用的版本。

    使用這些值來取代 **程式** 代碼檔案中的 **YOUR_PREDICTION_URL和YOUR_PREDICTION_KEY** 預留位置。

    貼上預測 URL 與預測金鑰值之後，前兩行程式碼看起來應該類似這樣：

    ```PowerShell
    $predictionUrl="https..."
    $predictionKey ="1a2b3c4d5e6f7g8h9i0j...."
    ```

5. 對程式碼中的變數進行變更之後，請按 **CTRL+S** 儲存檔案。 然後按 **CTRL+Q** 以關閉程式碼編輯器。

## 測試用戶端應用程式

現在，您可以使用範例用戶端應用程式來偵測影像中的自行車和腳踏車。

1. 在 PowerShell 窗格中，輸入下列命令來執行程式碼：

    ```PowerShell
    ./detect-objects.ps1 1
    ```

    此程式碼會使用您的模型來偵測下圖中的物件：

    ![腳踏車和自行車的相片。](media/create-object-detection-solution/road-safety-1.jpg)

1. 檢閱預測，其中列出以 90% 或更多機率偵測到的任何物件，以及其位置周圍周框方塊的座標。

1. 現在讓我們嘗試另一個映射。 請執行這個命令：

    ```PowerShell
    ./detect-objects.ps1 2
    ```

    這次會分析下列影像：

    ![一組客群的相片。](media/create-object-detection-solution/road-safety-2.jpg)

希望您的物件偵測模型在測試影像中偵測擷取和自行車者是很好的工作。

## 深入了解

本練習只會顯示自訂視覺服務的一些功能。 若要深入了解此服務的功能，請參閱[自訂視覺](https://azure.microsoft.com/services/cognitive-services/custom-vision-service/)頁面。
